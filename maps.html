<!DOCTYPE html>
<html>
<head>
    <title>Dynamic Heatmap with Points</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@latest/dist/leaflet-heat.js"></script>
    
    <style>
        #map { height: 100vh; width: 100%; }
        body { padding: 0; margin: 0; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // 4. Create a default location (now with an ID)
    var defaultLocations = [
        [51.505, -0.09, "Default_ID"]
    ];

    // 5. Get the URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    // e.g., "lat,lon,id|lat,lon,id"
    const locationsParam = urlParams.get('locations'); 
    
    // This will be [[lat, lon, id], [lat, lon, id], ...]
    var locations = []; 

    // 6. Parse the 'locations' parameter string (MODIFIED)
    if (locationsParam) {
        try {
            const locationsArray = locationsParam.split('|');
            
            locations = locationsArray.map(locString => {
                const parts = locString.split(',');
                
                const lat = parseFloat(parts[0]);
                const lon = parseFloat(parts[1]);
                
                // Get the ID (e.g., "V-aa23...").
                // parts.slice(2).join(',') handles cases where the ID might have a comma
                const id = parts.slice(2).join(',') || `Location_(${lat.toFixed(4)})`;

                if (isNaN(lat) || isNaN(lon)) return null;

                // Return [lat, lon, id]
                return [lat, lon, id]; 

            }).filter(loc => loc !== null);

            if (locations.length === 0) {
                locations = defaultLocations;
            }

        } catch (e) {
            console.error("Error parsing locations:", e);
            locations = defaultLocations;
        }
    } else {
        locations = defaultLocations;
    }

    // 7. Initialize the map
    var map = L.map('map').setView([locations[0][0], locations[0][1]], 10);

    // 8. Add the OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    // 9. Create an array of [lat, lon, intensity] for the heatmap
    // This correctly takes just the first two elements (lat, lon)
    const heatPoints = locations.map(loc => [loc[0], loc[1], 1.0]);

    // 10. Add heatmap, add circle markers, and add interactions (MODIFIED)
    if (heatPoints.length > 0) {
        
        // --- Add the heatmap layer ---
        L.heatLayer(heatPoints, {
            radius: 25,
            blur: 10,
            minOpacity: 0.3,
            maxZoom: 18
        }).addTo(map);

        // --- Add circle markers & interactions ---
        var markerGroup = L.featureGroup();
        
        // Define the base URL for the redirect
        var baseUrl = "https://ph-pov.eu-3.celonis.cloud/package-manager/ui/studio/ui/spaces/17861590-4c7f-45b3-b6e7-91d480bbaa96/packages/b9067f27-7266-44c0-b11c-a1d1d240a113/nodes/2c5115be-c441-4517-ad34-a3b76742cfec?filters=";

        for (var i = 0; i < locations.length; i++) {
            
            // Use an IIFE to correctly scope variables for click/hover
            (function() {
                var lat = locations[i][0];
                var lon = locations[i][1];
                var id = locations[i][2]; // This is the ID, e.g., "V-aa23..."
                
                // --- Create the link for the click action ---
                // 1. Create the filter string
                var filterString = `FILTER "o_custom_Vorgang"."ID" IN ('${id}');`;
                
                // 2. Base64 encode it
                var encodedFilter = btoa(filterString);
                
                // 3. Create the final URL
                var finalUrl = baseUrl + encodedFilter;

                // --- Create the circle marker ---
                var marker = L.circleMarker([lat, lon], {
                    radius: 6,
                    fillColor: "#0000FF",
                    color: "#FFFFFF",
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                });

                // Requirement 1: Show ID on HOVER
                marker.bindTooltip(id);

                // Requirement 2: Open link on CLICK
                marker.on('click', function() {
                    window.open(finalUrl, '_blank');
                });
                
                marker.addTo(markerGroup);

            })(); // End of IIFE
        }
        markerGroup.addTo(map);
        // ----------------------------------------------------------------

        // 11. Automatically zoom the map to fit all points
        // We now use markerGroup to make sure all points are visible
        map.fitBounds(markerGroup.getBounds().pad(0.5));
    }

</script>

</body>
</html>
